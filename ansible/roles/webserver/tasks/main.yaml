---

- name: Create Nginx directory
  tags: 'Nginx'
  become: yes
  file:
    path: "{{ nginx_dir }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: yes
    state: directory

- name: Create Node directory
  tags: 'Node'
  become: yes
  file:
    path: "{{ node_dir }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: yes
    state: directory


- name: Configure compose
  tags: 'Nginx'
  become: yes
  template:
    src: nginx-docker-compose.yaml.j2
    dest: "{{ root }}/docker-compose.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"


#- name: Upload node script
#  become: yes
#  copy:
#    src: npm.sh
#    dest: "{{ node_dir }}"
#    mode: 0777

#- name: Upload Default Configure
#  become: yes
#  copy:
#    src: default.conf
#    dest: "{{ nginx_dir }}"
#    mode: 0777
#
#- name: Upload nginx Configure
#  become: yes
#  copy:
#    src: nginx.conf
#    dest: "{{ nginx_dir }}"
#    mode: 0777

- name: Upload Node Dockerfile
  become: yes
  copy:
    src: Dockerfile
    dest: "{{ node_dir }}"
    mode: 0777

- name: Prune everything
  docker_prune:
    containers: yes
    images: yes
    networks: yes
    volumes: yes
    builder_cache: yes


- name: Run docker compose
  tags: 'Nginx'
  become: yes
  docker_compose:
    project_src: "{{ root }}"
    pull: yes
    state: present
    remove_orphans: yes
    recreate: always


